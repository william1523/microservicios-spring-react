-- ====================================================================
-- 0. SECUENCIAS: Identificadores únicos automáticos (NOCACHE CYCLE aplicado)
-- ====================================================================

CREATE SEQUENCE SEQ_EMPRESAS START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_SUCURSALES START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_UBICACIONES START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_PERSONAS START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_USUARIOS START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_MARCAS START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_VEHICULOS START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_IMPUESTOS START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_UNIDADES_MEDIDA START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_PRODUCTOS START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_CAPAS_COSTO START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_KARDEX START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_PUNTOS_EMISION START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_NOTAS_PEDIDO START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_DOCUMENTOS_VENTA START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_DETALLE_VENTA START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_DOCUMENTOS_COMPRA START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_DETALLE_COMPRA START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;
CREATE SEQUENCE SEQ_TIPOS_IDENTIFICACION START WITH 1 INCREMENT BY 1 MAXVALUE 99999 MINVALUE 1 NOCYCLE NOCACHE;


-- ====================================================================
-- 1. ESTRUCTURA ORGANIZACIONAL Y SEGURIDAD (VPD Core)
-- ====================================================================

-- TIPOS_IDENTIFICACION: Tabla Global para SRI
CREATE TABLE TIPOS_IDENTIFICACION (
    ID_TIPO_IDENTIFICACION NUMBER(10) PRIMARY KEY,
    NOMBRE_TIPO VARCHAR2(50) NOT NULL,
    CODIGO_SRI VARCHAR2(2) UNIQUE NOT NULL
);

-- EMPRESAS: Aislamiento, valoración y contribuyente SRI
CREATE TABLE EMPRESAS (
    ID_EMPRESA NUMBER(10) PRIMARY KEY,
    RUC VARCHAR2(13) UNIQUE NOT NULL,
    NOMBRE_EMPRESA VARCHAR2(255) NOT NULL,
    METODO_VALORACION VARCHAR2(20) DEFAULT 'PONDERADO' NOT NULL, 
    TIPO_CONTRIBUYENTE VARCHAR2(50) DEFAULT 'REGULAR' NOT NULL, 
    OBLIGADO_LLEVAR_CONT CHAR(1) DEFAULT 'N' CHECK (OBLIGADO_LLEVAR_CONT IN ('Y', 'N')),
    CONSTRAINT CHK_METODO_VALORACION CHECK (METODO_VALORACION IN ('FIFO', 'LIFO', 'PONDERADO'))
);

-- SUCURSALES: Código de Establecimiento SRI
CREATE TABLE SUCURSALES (
    ID_SUCURSAL NUMBER(10) PRIMARY KEY,
    EMPRESA_ID NUMBER(10) NOT NULL,
    NOMBRE_SUCURSAL VARCHAR2(100) NOT NULL,
    DIRECCION VARCHAR2(255),
    CODIGO_ESTABLECIMIENTO VARCHAR2(3) NOT NULL, 
    CONSTRAINT FK_SUCURSAL_EMPRESA FOREIGN KEY (EMPRESA_ID) REFERENCES EMPRESAS(ID_EMPRESA)
);

-- PUNTOS_EMISION: Secuenciales para SRI
CREATE TABLE PUNTOS_EMISION (
    ID_PUNTO_EMISION NUMBER(10) PRIMARY KEY,
    EMPRESA_ID NUMBER(10) NOT NULL,
    SUCURSAL_ID NUMBER(10) NOT NULL,
    CODIGO_PUNTO_EMISION VARCHAR2(3) NOT NULL,
    SECUENCIA_FACTURA NUMBER(9) DEFAULT 1 NOT NULL,
    SECUENCIA_NOTA_CREDITO NUMBER(9) DEFAULT 1 NOT NULL,
    NOMBRE_PUNTO_EMISION VARCHAR2(100),
    ESTADO CHAR(1) DEFAULT 'A' NOT NULL,
    CONSTRAINT FK_PUNTO_SUCURSAL FOREIGN KEY (SUCURSAL_ID) REFERENCES SUCURSALES(ID_SUCURSAL),
    CONSTRAINT UN_CODIGO_PUNTO UNIQUE (SUCURSAL_ID, CODIGO_PUNTO_EMISION),
    CONSTRAINT FK_PUNTO_EMPRESA FOREIGN KEY (EMPRESA_ID) REFERENCES EMPRESAS(ID_EMPRESA)
);

-- UBICACIONES: Físicas de Inventario
CREATE TABLE UBICACIONES (
    ID_UBICACION NUMBER(10) PRIMARY KEY,
    SUCURSAL_ID NUMBER(10) NOT NULL,
    CODIGO_UBICACION VARCHAR2(20) NOT NULL,
    CONSTRAINT UK_UBICACION UNIQUE (SUCURSAL_ID, CODIGO_UBICACION),
    CONSTRAINT FK_UBICACION_SUCURSAL FOREIGN KEY (SUCURSAL_ID) REFERENCES SUCURSALES(ID_SUCURSAL)
);

-- USUARIOS: Seguridad y Roles
CREATE TABLE USUARIOS (
    ID_USUARIO NUMBER(10) PRIMARY KEY,
    NOMBRE_USUARIO VARCHAR2(50) UNIQUE NOT NULL, 
    EMPRESA_ID NUMBER(10) NOT NULL,
    PUNTO_EMISION_ID NUMBER(10), 
    ROL VARCHAR2(20),
    CONSTRAINT FK_USUARIO_EMPRESA FOREIGN KEY (EMPRESA_ID) REFERENCES EMPRESAS(ID_EMPRESA),
    CONSTRAINT FK_USUARIO_PUNTO_EMISION FOREIGN KEY (PUNTO_EMISION_ID) REFERENCES PUNTOS_EMISION(ID_PUNTO_EMISION)
);

-- PERSONAS: Clientes y Proveedores
CREATE TABLE PERSONAS (
    ID_PERSONA NUMBER(10) PRIMARY KEY,
    EMPRESA_ID NUMBER(10) NOT NULL,
    RUC_CEDULA VARCHAR2(15) NOT NULL,
    TIPO_IDENTIFICACION_ID NUMBER(10) NOT NULL, 
    NOMBRE VARCHAR2(255) NOT NULL,
    TIPO_PERSONA CHAR(1) CHECK (TIPO_PERSONA IN ('C', 'P')), 
    DIRECCION VARCHAR2(255),
    CORREO_ELECTRONICO VARCHAR2(100),
    TELEFONO VARCHAR2(15),
    CONSTRAINT FK_PERSONA_EMPRESA FOREIGN KEY (EMPRESA_ID) REFERENCES EMPRESAS(ID_EMPRESA),
    CONSTRAINT FK_PERSONA_TIPO_ID FOREIGN KEY (TIPO_IDENTIFICACION_ID) REFERENCES TIPOS_IDENTIFICACION(ID_TIPO_IDENTIFICACION)
);


-- ====================================================================
-- 2. CATÁLOGO E INVENTARIO
-- ====================================================================

CREATE TABLE IMPUESTOS (
    ID_IMPUESTO NUMBER(10) PRIMARY KEY,
    NOMBRE_IMPUESTO VARCHAR2(50) NOT NULL,
    TARIFA NUMBER(5, 2) NOT NULL,
    CODIGO_IMPUESTO VARCHAR2(2),    
    CODIGO_TARIFA VARCHAR2(2)       
);

-- UNIDADES_MEDIDA (Incluye SIGLAS)
CREATE TABLE UNIDADES_MEDIDA (
    ID_UNIDAD NUMBER(10) PRIMARY KEY,
    NOMBRE_UNIDAD VARCHAR2(50) NOT NULL,
    SIGLAS VARCHAR2(5) NOT NULL, 
    PERMITE_DECIMALES CHAR(1) DEFAULT 'N'
);

CREATE TABLE PRODUCTOS (
    ID_PRODUCTO NUMBER(10) PRIMARY KEY,
    EMPRESA_ID NUMBER(10) NOT NULL,
    SKU VARCHAR2(50) NOT NULL,
    NOMBRE_PRODUCTO VARCHAR2(255) NOT NULL,
    UNIDAD_MEDIDA_ID NUMBER(10) NOT NULL,
    IMPUESTO_ID NUMBER(10), 
    COSTO_REFERENCIA NUMBER(18, 2) DEFAULT 0,
    CONSTRAINT UK_PROD_SKU_EMPRESA UNIQUE (EMPRESA_ID, SKU),
    CONSTRAINT FK_PROD_EMPRESA FOREIGN KEY (EMPRESA_ID) REFERENCES EMPRESAS(ID_EMPRESA),
    CONSTRAINT FK_PROD_UNIDAD FOREIGN KEY (UNIDAD_MEDIDA_ID) REFERENCES UNIDADES_MEDIDA(ID_UNIDAD),
    CONSTRAINT FK_PROD_IMPUESTO FOREIGN KEY (IMPUESTO_ID) REFERENCES IMPUESTOS(ID_IMPUESTO)
);
CREATE TABLE CAPAS_COSTO (
    ID_CAPA NUMBER(10) PRIMARY KEY,
    PRODUCTO_ID NUMBER(10) NOT NULL,
    SUCURSAL_ID NUMBER(10) NOT NULL,
    FECHA_INGRESO DATE NOT NULL,
    COSTO_UNITARIO NUMBER(18, 2) NOT NULL,
    CANTIDAD_INICIAL NUMBER(10, 3) NOT NULL,
    CANTIDAD_PENDIENTE NUMBER(10, 3) NOT NULL,
    CONSTRAINT FK_CAPA_PROD FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTOS(ID_PRODUCTO),
    CONSTRAINT FK_CAPA_SUC FOREIGN KEY (SUCURSAL_ID) REFERENCES SUCURSALES(ID_SUCURSAL)
);
CREATE TABLE STOCK (
    PRODUCTO_ID NUMBER(10) NOT NULL,
    SUCURSAL_ID NUMBER(10) NOT NULL,
    UBICACION_ID NUMBER(10) NOT NULL,
    CANTIDAD NUMBER(10, 3) NOT NULL,
    CANTIDAD_COMPROMETIDA NUMBER(10, 3) DEFAULT 0,
    CONSTRAINT PK_STOCK PRIMARY KEY (PRODUCTO_ID, SUCURSAL_ID, UBICACION_ID),
    CONSTRAINT FK_STOCK_PROD FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTOS(ID_PRODUCTO),
    CONSTRAINT FK_STOCK_SUC FOREIGN KEY (SUCURSAL_ID) REFERENCES SUCURSALES(ID_SUCURSAL),
    CONSTRAINT FK_STOCK_UBICACION FOREIGN KEY (UBICACION_ID) REFERENCES UBICACIONES(ID_UBICACION)
);
CREATE TABLE KARDEX (
    ID_KARDEX NUMBER(10) PRIMARY KEY,
    SUCURSAL_ID NUMBER(10) NOT NULL,
    PRODUCTO_ID NUMBER(10) NOT NULL,
    FECHA_MOVIMIENTO DATE NOT NULL,
    TIPO_MOVIMIENTO VARCHAR2(5),
    CANTIDAD NUMBER(10, 3) NOT NULL,
    COSTO_UNITARIO_MOV NUMBER(18, 2) NOT NULL,
    COSTO_SALDO NUMBER(18, 2) NOT NULL,
    CAPA_ID NUMBER(10), 
    REFERENCIA VARCHAR2(50),
    CONSTRAINT FK_KARDEX_SUCURSAL FOREIGN KEY (SUCURSAL_ID) REFERENCES SUCURSALES(ID_SUCURSAL),
    CONSTRAINT FK_KARDEX_PROD FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTOS(ID_PRODUCTO)
);


-- ====================================================================
-- 3. FLUJO DE VENTAS Y DOCUMENTOS (Salidas)
-- ====================================================================
CREATE TABLE NOTAS_PEDIDO (
    ID_PEDIDO NUMBER(10) PRIMARY KEY,
    SUCURSAL_ID NUMBER(10) NOT NULL,
    PERSONA_ID NUMBER(10) NOT NULL, 
    FECHA_PEDIDO DATE NOT NULL,
    ESTADO VARCHAR2(10),
    CONSTRAINT FK_PEDIDO_SUC FOREIGN KEY (SUCURSAL_ID) REFERENCES SUCURSALES(ID_SUCURSAL),
    CONSTRAINT FK_PEDIDO_PERSONA FOREIGN KEY (PERSONA_ID) REFERENCES PERSONAS(ID_PERSONA)
);
CREATE TABLE DOCUMENTOS_VENTA (
    ID_DOCUMENTO NUMBER(10) PRIMARY KEY,
    EMPRESA_ID NUMBER(10) NOT NULL,
    SUCURSAL_ID NUMBER(10) NOT NULL,
    PERSONA_ID NUMBER(10) NOT NULL, 
    TIPO_DOCUMENTO VARCHAR2(5) NOT NULL,
    PUNTO_EMISION_ID NUMBER(10) NOT NULL, 
    NUMERO_DOCUMENTO_SRI VARCHAR2(17) NOT NULL, 
    FECHA_EMISION DATE NOT NULL,
    VALOR_DESCUENTO NUMBER(18, 2) DEFAULT 0, 
    PEDIDO_ORIGEN_ID NUMBER(10),
    SRI_ESTADO VARCHAR2(20) DEFAULT 'PENDIENTE',
    SRI_CLAVE_ACCESO VARCHAR2(50),
    TOTAL_DOCUMENTO NUMBER(18, 2),
    SUBTOTAL_CERO NUMBER(18, 2) DEFAULT 0,
    SUBTOTAL_IVA NUMBER(18, 2) DEFAULT 0,
    VALOR_IVA NUMBER(18, 2) DEFAULT 0,
    CONSTRAINT FK_DOC_PUNTO_EMISION FOREIGN KEY (PUNTO_EMISION_ID) REFERENCES PUNTOS_EMISION(ID_PUNTO_EMISION),
    CONSTRAINT UN_DOC_SRI UNIQUE (EMPRESA_ID, TIPO_DOCUMENTO, NUMERO_DOCUMENTO_SRI),
    CONSTRAINT FK_DOC_EMPRESA FOREIGN KEY (EMPRESA_ID) REFERENCES EMPRESAS(ID_EMPRESA),
    CONSTRAINT FK_DOC_PERSONA FOREIGN KEY (PERSONA_ID) REFERENCES PERSONAS(ID_PERSONA)
);
CREATE TABLE DETALLE_VENTA (
    ID_DETALLE_VENTA NUMBER(10) PRIMARY KEY,
    DOCUMENTO_ID NUMBER(10) NOT NULL,
    PRODUCTO_ID NUMBER(10) NOT NULL,
    CANTIDAD NUMBER(10, 3) NOT NULL,
    PRECIO_UNITARIO NUMBER(18, 2) NOT NULL, 
    DESCUENTO_LINEA NUMBER(18, 2) DEFAULT 0, 
    SUBTOTAL NUMBER(18, 2) NOT NULL,
    VALOR_IMPUESTO NUMBER(18, 2) DEFAULT 0 NOT NULL, 
    CODIGO_IMPUESTO_SRI VARCHAR2(2),    
    CODIGO_TARIFA_SRI VARCHAR2(2),      
    TASA_APLICADA NUMBER(5, 2),
    CONSTRAINT FK_DETALLE_VENTA_DOC FOREIGN KEY (DOCUMENTO_ID) REFERENCES DOCUMENTOS_VENTA(ID_DOCUMENTO),
    CONSTRAINT FK_DETALLE_VENTA_PROD FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTOS(ID_PRODUCTO)
);


-- ====================================================================
-- 4. FLUJO DE COMPRAS Y DOCUMENTOS (Entradas)
-- ====================================================================
CREATE TABLE DOCUMENTOS_COMPRA (
    ID_DOCUMENTO_COMPRA NUMBER(10) PRIMARY KEY,
    EMPRESA_ID NUMBER(10) NOT NULL,
    PERSONA_ID NUMBER(10) NOT NULL, 
    TIPO_DOCUMENTO VARCHAR2(5) NOT NULL, 
    NUMERO_COMPROBANTE_PROV VARCHAR2(17) NOT NULL, 
    FECHA_EMISION DATE NOT NULL,
    VALOR_DESCUENTO NUMBER(18, 2) DEFAULT 0, 
    TOTAL_DOCUMENTO NUMBER(18, 2),
    SUBTOTAL_CERO NUMBER(18, 2) DEFAULT 0,
    SUBTOTAL_IVA NUMBER(18, 2) DEFAULT 0,
    VALOR_IVA NUMBER(18, 2) DEFAULT 0,
    ESTADO VARCHAR2(20) DEFAULT 'REGISTRADO',
    CONSTRAINT FK_COMPRA_PERSONA FOREIGN KEY (PERSONA_ID) REFERENCES PERSONAS(ID_PERSONA),
    CONSTRAINT UN_COMPRA_PROV UNIQUE (EMPRESA_ID, PERSONA_ID, NUMERO_COMPROBANTE_PROV)
);
CREATE TABLE DETALLE_COMPRA (
    ID_DETALLE_COMPRA NUMBER(10) PRIMARY KEY,
    DOCUMENTO_COMPRA_ID NUMBER(10) NOT NULL,
    PRODUCTO_ID NUMBER(10), 
    DESCRIPCION VARCHAR2(255) NOT NULL, 
    CANTIDAD NUMBER(10, 3) NOT NULL,
    COSTO_UNITARIO NUMBER(18, 2) NOT NULL, 
    DESCUENTO_LINEA NUMBER(18, 2) DEFAULT 0, 
    SUBTOTAL NUMBER(18, 2) NOT NULL,
    VALOR_IMPUESTO NUMBER(18, 2) DEFAULT 0 NOT NULL, 
    CODIGO_IMPUESTO_SRI VARCHAR2(2),    
    TASA_APLICADA NUMBER(5, 2),
    CONSTRAINT FK_DETALLE_COMPRA_DOC FOREIGN KEY (DOCUMENTO_COMPRA_ID) REFERENCES DOCUMENTOS_COMPRA(ID_DOCUMENTO_COMPRA),
    CONSTRAINT FK_DETALLE_COMPRA_PROD FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTOS(ID_PRODUCTO)
);